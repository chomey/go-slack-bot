VERSION := $(shell echo `cat VERSION`+`git log -1 --pretty=format:%h`)
SERVICE_NAME := go_slack_bot
IMAGE_TAG = $(shell echo $(VERSION) | sed 's|[+:]|-|g')
IMAGE_NAME := chomey/$(SERVICE_NAME):$(IMAGE_TAG)
RC_HOSTNAME ?= localhost

BUILD_CONTAINER_IMAGE := golang:1.10
BUILD_CONTAINER_NAME := $(SERVICE_NAME)_builder

####### Rules for development, default to run build in container, no dependency on local dev environment setup #######
# First rule, as the default rule. Donâ€™t move it.
build: version start_build_container container_test container_build image

compile:
#	bash -c "CGO_ENABLED=0 GOARCH=amd64 GOOS=darwin go build -ldflags '-X github.com/chomey/go_slack_bot/service.VERSION=$(VERSION)' -o bin/go_slack_bot_darwin_amd64"
#	bash -c "CGO_ENABLED=0 GOARCH=386 GOOS=linux go build -ldflags '-X github.com/chomey/go_slack_bot/service.VERSION=$(VERSION)' -o bin/go_slack_bot_linux_386"
	bash -c "CGO_ENABLED=0 GOARCH=amd64 GOOS=linux go build -ldflags '-X github.com/chomey/go_slack_bot/service.VERSION=$(VERSION)' -o bin/go_slack_bot_linux_amd64"
#	bash -c "CGO_ENABLED=0 GOARCH=386 GOOS=windows go build -ldflags '-X github.com/chomey/go_slack_bot/service.VERSION=$(VERSION)' -o bin/go_slack_bot_windows_386"
#	bash -c "CGO_ENABLED=0 GOARCH=amd64 GOOS=windows go build -ldflags '-X github.com/chomey/go_slack_bot/service.VERSION=$(VERSION)' -o bin/go_slack_bot_windows_amd64"
	docker build -t "chomey/go_slack_bot:dev" .

run:
	docker-compose rm -f 2>/dev/null || true
	VERSION=$(IMAGE_TAG) RC_HOSTNAME=$(RC_HOSTNAME) RC_PRIVATE_KEY=$(RC_PRIVATE_KEY) docker-compose up

local_test:
	go test `go list ./... | grep -v /vendor/`

image: build
	docker build -t $(IMAGE_NAME) . && docker tag $(IMAGE_NAME) "go_slack_bot:localdev"

clean:
	docker rm -f $(BUILD_CONTAINER_NAME) 2> /dev/null || true
	rm bin/* || true

.PHONY: build run local_run build clean container_

